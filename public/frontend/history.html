<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch History - iTechTube</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .history-item {
            background: var(--dark-gray);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: transform 0.2s ease;
        }
        .history-item:hover {
            transform: translateX(5px);
        }
        .history-thumbnail {
            width: 160px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
        }
        .progress-stats {
            font-size: 0.85rem;
        }
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }
        .empty-state i {
            font-size: 5rem;
            margin-bottom: 1rem;
        }
        .filter-tabs .nav-link.active {
            background-color: var(--primary-red) !important;
            border-color: var(--primary-red) !important;
            color: white !important;
        }
        .filter-tabs .nav-link {
            color: white;
        }
        .watch-again-btn {
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-play-circle text-yellow me-2"></i>
                <span class="logo">iTechTube</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">Dashboard</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logout-btn">
                            <i class="fas fa-sign-out-alt me-1"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- History Content -->
    <div class="container mt-4">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-yellow mb-1">
                    <i class="fas fa-history me-2"></i>Watch History
                </h2>
                <p class="text-muted mb-0">Videos you've watched</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-light" onclick="loadHistory()">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
                <button class="btn btn-outline-danger" onclick="clearAllHistory()" id="clear-history-btn" style="display: none;">
                    <i class="fas fa-trash me-1"></i> Clear All
                </button>
            </div>
        </div>

        <!-- Filter Tabs -->
        <ul class="nav nav-tabs mb-4 filter-tabs" id="history-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="filterHistory('all', this)">
                    All
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="filterHistory('incomplete', this)">
                    <i class="fas fa-play-circle me-1"></i> In Progress
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="filterHistory('completed', this)">
                    <i class="fas fa-check-circle me-1"></i> Completed
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="filterHistory('today', this)">
                    <i class="fas fa-clock me-1"></i> Today
                </a>
            </li>
        </ul>

        <!-- History List -->
        <div id="history-container">
            <div class="text-center text-muted py-5">
                <div class="loading"></div>
                <p class="mt-3">Loading watch history...</p>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state bg-dark rounded" id="empty-state" style="display: none;">
            <i class="fas fa-history text-muted"></i>
            <h3 class="text-white mt-3">No watch history</h3>
            <p class="text-muted">Videos you watch will appear here</p>
            <a href="index.html" class="btn btn-danger mt-3">
                <i class="fas fa-play me-1"></i> Start Watching
            </a>
        </div>

        <!-- Login Required -->
        <div class="empty-state bg-dark rounded" id="login-required" style="display: none;">
            <i class="fas fa-user-lock text-muted"></i>
            <h3 class="text-white mt-3">Login Required</h3>
            <p class="text-muted">Please login to view your watch history</p>
            <a href="login.html" class="btn btn-danger mt-3">
                <i class="fas fa-sign-in-alt me-1"></i> Login
            </a>
        </div>
    </div>

    <!-- Clear Confirmation Modal -->
    <div class="modal fade" id="clearHistoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title text-yellow">Clear Watch History</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to clear all your watch history? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmClearHistory()">Clear All</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        let watchHistory = [];
        let currentFilter = 'all';

        // Initialize history page
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            if (!isAuthenticated()) {
                document.getElementById('history-container').style.display = 'none';
                document.getElementById('login-required').style.display = 'block';
                return;
            }

            // Setup logout handler
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                logout();
            });

            // Load history
            await loadHistory();
        });

        // Load watch history
        async function loadHistory() {
            const container = document.getElementById('history-container');
            container.innerHTML = '<div class="text-center text-muted py-5"><div class="loading"></div><p class="mt-3">Loading...</p></div>';

            try {
                const response = await loadWatchHistory();
                watchHistory = response?.data || [];

                updateHistoryUI(watchHistory);

                // Show clear button if has history
                document.getElementById('clear-history-btn').style.display =
                    watchHistory.length > 0 ? 'block' : 'none';

            } catch (error) {
                console.error('Error loading history:', error);
                container.innerHTML = '<div class="text-center text-danger py-5">Error loading watch history</div>';
            }
        }

        // Update UI with history data
        function updateHistoryUI(history) {
            const container = document.getElementById('history-container');
            const emptyState = document.getElementById('empty-state');

            if (history.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            emptyState.style.display = 'none';

            container.innerHTML = history.map(item => createHistoryItem(item)).join('');
        }

        // Create history item HTML
        function createHistoryItem(item) {
            const video = item.video;
            if (!video) return '';

            const thumbnail = video.thumbnail_path
                ? `${STORAGE_URL}/${video.thumbnail_path}`
                : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="90" viewBox="0 0 160 90"><rect fill="%23333" width="160" height="90"/><text fill="%23666" font-family="Arial" font-size="10" x="50%" y="50%" text-anchor="middle">No Thumbnail</text></svg>';

            const duration = formatDuration(video.duration || 0);
            const progress = item.progress || 0;
            const percentComplete = video.duration ? Math.min((progress / video.duration) * 100, 100) : 0;
            const remaining = Math.max((video.duration || 0) - progress, 0);

            const watchedDate = new Date(item.watched_at || Date.now());
            const timeAgo = formatTimeAgo(watchedDate);

            const completedBadge = item.completed
                ? '<span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Completed</span>'
                : '';

            return `
                <div class="row history-item align-items-center">
                    <div class="col-auto">
                        <a href="video.html?id=${video.id}">
                            <img src="${thumbnail}" alt="${escapeHtml(video.title)}" class="history-thumbnail">
                        </a>
                    </div>
                    <div class="col">
                        <h5 class="mb-1">
                            <a href="video.html?id=${video.id}" class="text-decoration-none text-white">
                                ${escapeHtml(video.title)}
                            </a>
                            ${completedBadge}
                        </h5>
                        <p class="text-muted small mb-2">${video.user?.name || 'Unknown'}</p>
                        <div class="progress-stats">
                            <span class="text-muted">
                                <i class="fas fa-clock me-1"></i>${timeAgo}
                            </span>
                            <span class="text-muted ms-3">
                                <i class="fas fa-eye me-1"></i>${formatNumber(video.views_count || 0)} views
                            </span>
                        </div>
                    </div>
                    <div class="col-auto text-end">
                        <div class="mb-2">
                            <small class="text-muted">${formatDuration(progress)} / ${duration}</small>
                        </div>
                        <div class="progress mb-2" style="width: 150px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: ${percentComplete}%"></div>
                        </div>
                        <small class="text-muted d-block mb-2">
                            ${item.completed ? 'Finished' : formatDuration(remaining) + ' left'}
                        </small>
                        <a href="video.html?id=${video.id}" class="btn btn-sm btn-danger watch-again-btn">
                            <i class="fas fa-play me-1"></i>
                            ${item.completed ? 'Watch Again' : 'Continue'}
                        </a>
                    </div>
                </div>
            `;
        }

        // Format time ago
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)} days ago`;
            if (diff < 2592000) return `${Math.floor(diff / 604800)} weeks ago`;
            return formatDate(date.toISOString());
        }

        // Filter history
        function filterHistory(filter, btn) {
            currentFilter = filter;

            // Update tab state
            document.querySelectorAll('#history-tabs .nav-link').forEach(tab => {
                tab.classList.remove('active');
            });
            btn.classList.add('active');

            let filtered = watchHistory;

            switch(filter) {
                case 'incomplete':
                    filtered = watchHistory.filter(item => !item.completed);
                    break;
                case 'completed':
                    filtered = watchHistory.filter(item => item.completed);
                    break;
                case 'today':
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    filtered = watchHistory.filter(item => new Date(item.watched_at) >= today);
                    break;
                default:
                    filtered = watchHistory;
            }

            updateHistoryUI(filtered);
        }

        // Clear all history
        function clearAllHistory() {
            const modal = new bootstrap.Modal(document.getElementById('clearHistoryModal'));
            modal.show();
        }

        // Confirm clear history
        async function confirmClearHistory() {
            try {
                await apiRequest('/history', { method: 'DELETE' });
                watchHistory = [];
                updateHistoryUI([]);
                document.getElementById('clear-history-btn').style.display = 'none';

                const modal = bootstrap.Modal.getInstance(document.getElementById('clearHistoryModal'));
                modal.hide();

                showAlert('Watch history cleared', 'success');
            } catch (error) {
                showAlert('Failed to clear history: ' + error.message, 'danger');
            }
        }
    </script>
</body>
</html>

